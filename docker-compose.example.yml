services:
  dcapi:
    build:
      context: .
      dockerfile_inline: |
        # Stage 1: Build the SvelteKit frontend
        FROM node:22-alpine AS frontend
        WORKDIR /app
        COPY dcgui/package*.json ./
        RUN npm ci
        COPY dcgui/ ./
        RUN npm run build

        # Stage 2: Build the Go binary (with embedded UI)
        FROM golang:alpine AS builder
        WORKDIR /build
        COPY dcapi/go.mod dcapi/go.sum ./
        RUN go mod download
        COPY dcapi/ ./
        COPY --from=frontend /app/build ./ui
        RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o dcapi .

        # Stage 3: Runtime — Docker CLI image so dcapi can invoke docker/docker compose
        FROM docker:cli
        COPY --from=builder /build/dcapi /usr/local/bin/dcapi
        EXPOSE 8882
        CMD ["dcapi"]
    container_name: dcapi
    environment:
      - TZ=${TZ}
      # Credentials (pick one approach):
      # Option A — plain env vars
      # - ADMIN_USERNAME=admin
      # - ADMIN_PASSWORD=changeme
      # Option B — read from files (use with secrets below)
      # - ADMIN_USERNAME_FILE=/run/secrets/admin_username
      # - ADMIN_PASSWORD_FILE=/run/secrets/admin_password
    volumes:
      # Stacks + prod.env live here; auto-detected by dcapi
      - ${HOME}/.local/containers:/containers
      # Docker socket — use whichever matches your Docker installation:
      # Rootless Docker (most common for non-root users):
      - /run/user/${UID}/docker.sock:/var/run/docker.sock
      # Standard root Docker:
      # - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8882:8882"
    networks:
      - dcapi
    restart: unless-stopped

  # secrets:
  #   - admin_username
  #   - admin_password

networks:
  dcapi:
    driver: bridge

# secrets:
#   admin_username:
#     file: ./secrets/admin_username.txt
#   admin_password:
#     file: ./secrets/admin_password.txt
